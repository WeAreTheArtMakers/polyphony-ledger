apiVersion: 1

groups:
  - orgId: 1
    name: polyphony-platform-alerts
    folder: Polyphony Alerts
    interval: 1m
    rules:
      - uid: poly-dlq-detected
        title: DLQ Messages Detected
        condition: B
        for: 2m
        noDataState: NoData
        execErrState: Alerting
        annotations:
          summary: DLQ traffic detected in the last 5 minutes.
          runbook_url: http://localhost:3001/d/poly-kafka-pipeline/polyphony-kafka-pipeline
        labels:
          severity: critical
          source: kafka
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: sum(increase(polyphony_dlq_messages_total[5m]))
              instant: false
              intervalMs: 1000
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold

      - uid: poly-fe-errors-spike
        title: Frontend Client Errors Spike
        condition: B
        for: 2m
        noDataState: NoData
        execErrState: Alerting
        annotations:
          summary: Frontend client errors exceeded threshold in the last 5 minutes.
          runbook_url: http://localhost:3001/d/poly-api-metrics/polyphony-api-metrics
        labels:
          severity: warning
          source: frontend
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: sum(increase(polyphony_frontend_client_errors_total[5m]))
              instant: false
              intervalMs: 1000
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 3
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold

      - uid: poly-fe-poor-vitals
        title: Poor Web Vitals Detected
        condition: B
        for: 2m
        noDataState: NoData
        execErrState: Alerting
        annotations:
          summary: At least one poor frontend Web Vital was reported in the last 10 minutes.
          runbook_url: http://localhost:3001/d/poly-api-metrics/polyphony-api-metrics
        labels:
          severity: warning
          source: frontend
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: sum(increase(polyphony_frontend_web_vitals_total{rating="poor"}[10m]))
              instant: false
              intervalMs: 1000
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
