services:
  redpanda:
    ports:
      - '127.0.0.1:9092:9092'
      - '127.0.0.1:19092:19092'
      - '127.0.0.1:8081:8081'
      - '127.0.0.1:9644:9644'

  redpanda-console:
    ports:
      - '127.0.0.1:8080:8080'

  postgres:
    ports:
      - '127.0.0.1:5432:5432'

  clickhouse:
    ports:
      - '127.0.0.1:8123:8123'
      - '127.0.0.1:9000:9000'

  jaeger:
    ports:
      - '127.0.0.1:16686:16686'

  otel-collector:
    ports:
      - '127.0.0.1:4317:4317'
      - '127.0.0.1:4318:4318'

  backend:
    environment:
      CORS_ORIGINS: http://localhost:3000,https://${APP_DOMAIN}
      AUTH_MODE: ${AUTH_MODE}
      OIDC_ISSUER_URL: ${OIDC_ISSUER_URL}
      OIDC_AUDIENCE: ${OIDC_AUDIENCE}
      OIDC_JWKS_URL: ${OIDC_JWKS_URL}
      OIDC_ROLE_CLAIM: ${OIDC_ROLE_CLAIM}
      OIDC_WORKSPACE_CLAIM: ${OIDC_WORKSPACE_CLAIM}
      OIDC_SUBJECT_CLAIM: ${OIDC_SUBJECT_CLAIM}
      OIDC_ALGORITHMS: ${OIDC_ALGORITHMS}
    ports:
      - '127.0.0.1:8000:8000'

  frontend:
    environment:
      NEXT_PUBLIC_API_BASE: https://${API_DOMAIN}
      NEXT_PUBLIC_WS_URL: wss://${API_DOMAIN}/ws/stream
      NEXT_PUBLIC_JAEGER_URL: https://${TRACE_DOMAIN}
      NEXT_PUBLIC_HOME_ROUTE: /sales
    ports:
      - '127.0.0.1:3000:3000'

  prometheus:
    ports:
      - '127.0.0.1:9090:9090'

  grafana:
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
    ports:
      - '127.0.0.1:3001:3000'

  cloudflared:
    image: cloudflare/cloudflared:latest
    depends_on:
      - frontend
      - backend
      - grafana
      - jaeger
    command:
      - tunnel
      - --no-autoupdate
      - run
      - --token
      - ${CLOUDFLARE_TUNNEL_TOKEN}
    restart: unless-stopped
